// Regression test: ? operator on error-only expression should compile without panic
// Bug: unpack() in vo-analysis panicked on x.typ.unwrap() when x.typ was None
// Fix: Handle NoValue/None case in unpack() before calling unwrap()
package main

import "errors"

func main() {
	// Test 1: ? on function returning (T, error) - should work
	result := testValueAndError()
	assert(result == 42, "value and error ?")
	
	// Test 2: errdefer with ? - the original crash scenario
	result2 := testErrdefer()
	assert(result2 == "success", "errdefer with ?")
	
	println("PASSED")
}

func testValueAndError() int {
	v := getValue()?
	return v
}

func getValue() (int, error) {
	return 42, nil
}

func testErrdefer() string {
	// errdefer should run when error propagates
	noError()?
	return "success"
}

func noError() error {
	errdefer func() {
		// This errdefer should compile fine
	}()
	return nil
}

func assert(cond bool, msg string) {
	if !cond {
		panic("assertion failed: " + msg)
	}
}
