// Test: Panic/recover edge cases
package main

import "fmt"

// Test 1: Recover returns nil when no panic
func testRecoverNoPanic() {
	var recovered any
	func() {
		defer func() {
			recovered = recover()
		}()
		// No panic here
	}()
	
	assert(recovered == nil, "test1: recover without panic should return nil")
	fmt.Println("Test 1: PASSED - recover without panic")
}

// Test 2: Recover with different panic values
func testRecoverDifferentTypes() {
	// Panic with int
	var r1 any
	func() {
		defer func() { r1 = recover() }()
		panic(42)
	}()
	assert(r1.(int) == 42, "test2a: int panic")
	
	// Panic with string
	var r2 any
	func() {
		defer func() { r2 = recover() }()
		panic("error message")
	}()
	assert(r2.(string) == "error message", "test2b: string panic")
	
	// Panic with struct
	type ErrData struct {
		code int
		msg  string
	}
	var r3 any
	func() {
		defer func() { r3 = recover() }()
		panic(ErrData{500, "internal error"})
	}()
	ed := r3.(ErrData)
	assert(ed.code == 500 && ed.msg == "internal error", "test2c: struct panic")
	
	fmt.Println("Test 2: PASSED - different panic types")
}

// Test 3: Second recover in same defer returns nil
func testDoubleRecover() {
	var r1, r2 any
	func() {
		defer func() {
			r1 = recover()
			r2 = recover() // Should return nil
		}()
		panic("test")
	}()
	
	assert(r1.(string) == "test", "test3: first recover")
	assert(r2 == nil, "test3: second recover should be nil")
	fmt.Println("Test 3: PASSED - double recover")
}

// Test 4: Recover only works in deferred function
func testRecoverOnlyInDefer() {
	var directRecover any
	
	func() {
		defer func() {
			// This recover should work
			recover()
		}()
		
		// This recover should NOT work (not in deferred function)
		directRecover = recover()
		panic("test")
	}()
	
	assert(directRecover == nil, "test4: recover outside defer should be nil")
	fmt.Println("Test 4: PASSED - recover only in defer")
}

// Test 5: Nested panic/recover
func testNestedPanicRecover() {
	var outer, inner any
	
	func() {
		defer func() {
			outer = recover()
		}()
		
		func() {
			defer func() {
				inner = recover()
			}()
			panic("inner panic")
		}()
		
		// If inner panic was recovered, we continue here
		panic("outer panic")
	}()
	
	assert(inner.(string) == "inner panic", "test5: inner panic")
	assert(outer.(string) == "outer panic", "test5: outer panic")
	fmt.Println("Test 5: PASSED - nested panic/recover")
}

// Test 6: Panic in defer after panic
func testPanicInDefer() {
	var recovered any
	
	func() {
		defer func() {
			recovered = recover()
		}()
		defer func() {
			panic("defer panic") // This replaces the original panic
		}()
		panic("original panic")
	}()
	
	// The second panic should replace the first
	assert(recovered.(string) == "defer panic", "test6: defer panic replaces original")
	fmt.Println("Test 6: PASSED - panic in defer")
}

// Test 7: Named return modified by recover
func testNamedReturnRecover() (result int) {
	defer func() {
		if r := recover(); r != nil {
			result = -1
		}
	}()
	
	result = 100
	panic("test")
	return result
}

func main() {
	testRecoverNoPanic()
	testRecoverDifferentTypes()
	testDoubleRecover()
	testRecoverOnlyInDefer()
	testNestedPanicRecover()
	testPanicInDefer()
	
	r := testNamedReturnRecover()
	assert(r == -1, "test7: named return modified by recover")
	fmt.Println("Test 7: PASSED - named return with recover")
	
	fmt.Println("panic_recover_edge: ALL PASSED")
}
