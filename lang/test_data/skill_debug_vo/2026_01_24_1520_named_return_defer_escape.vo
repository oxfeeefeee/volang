package main

// Test: Named return variables must escape when function has defer,
// ensuring correct panic/recover semantics even when not explicitly referenced.

// Test 1: Named return preserved through recover (without explicit reference)
func preserveNamedReturn() (result int) {
	result = 5
	
	defer func() {
		if r := recover(); r != nil {
			// Don't reference result - bug was that result was reset to 0
		}
	}()
	
	panic("test")
}

func testPreserveNamedReturn() {
	r := preserveNamedReturn()
	assert(r == 5, "preserve named return")
}

// Test 2: Named return with explicit reference (should also work)
func preserveWithRef() (result int) {
	result = 10
	
	defer func() {
		if r := recover(); r != nil {
			_ = result // Reference it
		}
	}()
	
	panic("test")
}

func testPreserveWithRef() {
	r := preserveWithRef()
	assert(r == 10, "preserve with ref")
}

// Test 3: Recover modifying named return
func recoverModify() (result int) {
	defer func() {
		if r := recover(); r != nil {
			result = 42
		}
	}()
	
	panic("test")
}

func testRecoverModify() {
	r := recoverModify()
	assert(r == 42, "recover modify")
}

// Test 4: Multiple named returns
func multiNamedReturn() (a int, b string) {
	a = 1
	b = "hello"
	
	defer func() {
		if r := recover(); r != nil {
			a = 100
			b = "recovered"
		}
	}()
	
	panic("test")
}

func testMultiNamedReturn() {
	a, b := multiNamedReturn()
	assert(a == 100, "multi named a")
	assert(b == "recovered", "multi named b")
}

// Test 5: Named return preserved without modification
func preserveNoModify() (result int) {
	result = 77
	
	defer func() {
		recover()
		// Don't modify result
	}()
	
	panic("test")
}

func testPreserveNoModify() {
	r := preserveNoModify()
	assert(r == 77, "preserve no modify")
}

// Test 6: Closure with named return and defer
func testClosureNamedReturnDefer() {
	f := func() (result int) {
		result = 33
		
		defer func() {
			recover()
		}()
		
		panic("closure panic")
	}
	
	r := f()
	assert(r == 33, "closure named return defer")
}

// Test 7: Named return with errdefer
func namedReturnErrdefer() (result int, err error) {
	result = 88
	
	errdefer func() {
		// This runs on error return
	}()
	
	return result, nil
}

func testNamedReturnErrdefer() {
	r, err := namedReturnErrdefer()
	assert(err == nil, "no error")
	assert(r == 88, "named return errdefer")
}

func main() {
	testPreserveNamedReturn()
	testPreserveWithRef()
	testRecoverModify()
	testMultiNamedReturn()
	testPreserveNoModify()
	testClosureNamedReturnDefer()
	testNamedReturnErrdefer()
	println("PASS")
}
