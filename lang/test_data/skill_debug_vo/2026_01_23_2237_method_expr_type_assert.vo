// Test: Method expressions on type assertion results
package main

type Adder struct {
	base int
}

func (a Adder) Add(n int) int {
	return a.base + n
}

func (a *Adder) AddPtr(n int) int {
	return a.base + n
}

func (a Adder) GetBase() int {
	return a.base
}

type Multiplier struct {
	factor int
}

func (m Multiplier) Mul(n int) int {
	return m.factor * n
}

// Test 1: Method expression on type assertion - value receiver
func testMethodExprTypeAssertValue() {
	var a any = Adder{base: 10}
	
	// Get method expression from type
	addMethod := Adder.Add
	
	// Use with asserted value
	result := addMethod(a.(Adder), 5)
	assert(result == 15, "method expr type assert value")
}

// Test 2: Method expression on type assertion - pointer receiver
func testMethodExprTypeAssertPointer() {
	adder := &Adder{base: 20}
	var a any = adder
	
	addPtrMethod := (*Adder).AddPtr
	result := addPtrMethod(a.(*Adder), 7)
	assert(result == 27, "method expr type assert pointer")
}

// Test 3: Chain method expression and type assertion
func testChainMethodExprAssert() {
	var a any = Adder{base: 100}
	
	// Chain: get base, then use in add
	getBase := Adder.GetBase
	base := getBase(a.(Adder))
	
	add := Adder.Add
	result := add(a.(Adder), base)
	assert(result == 200, "chain method expr assert 100+100")
}

// Test 4: Method expression on type assertion in loop
func testMethodExprAssertLoop() {
	adders := []any{Adder{base: 1}, Adder{base: 2}, Adder{base: 3}}
	add := Adder.Add
	
	sum := 0
	for _, a := range adders {
		sum += add(a.(Adder), 10)
	}
	assert(sum == 36, "method expr assert loop (1+10)+(2+10)+(3+10)=36")
}

// Test 5: Method expression stored in variable, used with type assertion
func testStoredMethodExpr() {
	var op func(Adder, int) int = Adder.Add
	
	var a any = Adder{base: 50}
	result := op(a.(Adder), 25)
	assert(result == 75, "stored method expr")
}

// Test 6: Method expression on embedded type after assertion
type Wrapper struct {
	Adder
	extra int
}

func testMethodExprEmbedAssert() {
	var w any = Wrapper{Adder: Adder{base: 30}, extra: 5}
	
	// Get Adder method expression, use on Wrapper's embedded Adder
	add := Adder.Add
	wrapper := w.(Wrapper)
	result := add(wrapper.Adder, 10)
	assert(result == 40, "method expr embed assert")
}

// Test 7: Type assertion in method expression receiver position (inline)
func testInlineTypeAssertMethodExpr() {
	var a any = Adder{base: 7}
	
	// Direct call with type assertion as receiver
	result := Adder.Add(a.(Adder), 3)
	assert(result == 10, "inline type assert method expr")
}

// Test 8: Multiple method expressions with same type assertion
func testMultiMethodExprSameAssert() {
	var a any = Adder{base: 42}
	adder := a.(Adder)
	
	add := Adder.Add
	getBase := Adder.GetBase
	
	r1 := add(adder, 8)
	r2 := getBase(adder)
	
	assert(r1 == 50, "multi method expr add")
	assert(r2 == 42, "multi method expr getBase")
}

// Test 9: Method expression with type switch
func testMethodExprTypeSwitch() {
	items := []any{Adder{base: 5}, Multiplier{factor: 3}}
	
	results := make([]int, 0)
	for _, item := range items {
		switch v := item.(type) {
		case Adder:
			add := Adder.Add
			results = append(results, add(v, 10))
		case Multiplier:
			mul := Multiplier.Mul
			results = append(results, mul(v, 10))
		}
	}
	
	assert(len(results) == 2, "type switch results len")
	assert(results[0] == 15, "type switch adder 5+10")
	assert(results[1] == 30, "type switch multiplier 3*10")
}

// Test 10: Method expression on ok-form type assertion
func testMethodExprOkAssert() {
	var a any = Adder{base: 99}
	
	if adder, ok := a.(Adder); ok {
		add := Adder.Add
		result := add(adder, 1)
		assert(result == 100, "method expr ok assert")
	} else {
		panic("should be Adder")
	}
}

func main() {
	testMethodExprTypeAssertValue()
	println("Test 1: PASSED - method expr type assert value")
	
	testMethodExprTypeAssertPointer()
	println("Test 2: PASSED - method expr type assert pointer")
	
	testChainMethodExprAssert()
	println("Test 3: PASSED - chain method expr assert")
	
	testMethodExprAssertLoop()
	println("Test 4: PASSED - method expr assert loop")
	
	testStoredMethodExpr()
	println("Test 5: PASSED - stored method expr")
	
	testMethodExprEmbedAssert()
	println("Test 6: PASSED - method expr embed assert")
	
	testInlineTypeAssertMethodExpr()
	println("Test 7: PASSED - inline type assert method expr")
	
	testMultiMethodExprSameAssert()
	println("Test 8: PASSED - multi method expr same assert")
	
	testMethodExprTypeSwitch()
	println("Test 9: PASSED - method expr type switch")
	
	testMethodExprOkAssert()
	println("Test 10: PASSED - method expr ok assert")
	
	println("ALL PASSED")
}

func assert(cond bool, msg string) {
	if !cond {
		panic("assertion failed: " + msg)
	}
}
