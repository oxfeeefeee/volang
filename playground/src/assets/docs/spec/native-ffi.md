# Vo Native FFI Design

## Overview

This document describes the Native FFI (Foreign Function Interface) mechanism for the Vo language, allowing users to implement Vo functions in Rust.

## Design Goals

1. **Simple user interface**: Write ordinary Rust functions, macros handle conversion automatically
2. **Compile-time safety**: Signature mismatches cause compile errors, not runtime errors
3. **Zero runtime overhead**: Macro expands to direct slot access, no extra checks
4. **Consistent with Vo module system**: Import path resolution reuses vo-module logic

## Architecture

### Crate Structure

```
crates/
├── vo-module/        # Module resolution
│   └── resolver.rs   # Import path resolution logic
│
├── vo-runtime/       # Runtime (VM + JIT shared)
│   └── src/ffi/      # ExternCall, ExternResult, AnySlot definitions
│
├── vo-vm/            # VM interpreter
│
├── vo-jit/           # JIT compiler
│
├── vo-ffi-macro/     # proc macro implementation
│
└── vo-ext/           # User SDK (re-exports macros and types)
```

### Dependency Graph

```
Compile-time:
  user crate ──[proc-macro]──> vo-ffi-macro ──> vo-module

Runtime:
  user crate ──> vo-ext ──> vo-runtime
```

## Type Definitions

### ExternCall (vo-runtime/src/ffi/mod.rs)

```rust
/// External function call context
pub struct ExternCall<'a> {
    stack: &'a mut [u64],
    bp: usize,
    arg_start: u16,
    arg_count: u16,
    ret_start: u16,
}

impl ExternCall<'_> {
    // Argument reading
    pub fn arg_i64(&self, n: u16) -> i64;
    pub fn arg_f64(&self, n: u16) -> f64;
    pub fn arg_bool(&self, n: u16) -> bool;
    pub fn arg_str(&self, n: u16) -> &str;
    
    // Return value writing
    pub fn ret_i64(&mut self, n: u16, val: i64);
    pub fn ret_f64(&mut self, n: u16, val: f64);
    pub fn ret_bool(&mut self, n: u16, val: bool);
    pub fn ret_str(&mut self, n: u16, s: &str);
}

/// Context with full runtime access (GC, metadata)
pub struct ExternCallContext<'a> {
    call: ExternCall<'a>,
    // ... access to GC, metadata, etc.
}
```

### ExternResult

```rust
pub enum ExternResult {
    Ok,
    Yield,
    Panic(String),
}
```

## User Interface

Users should use the `vo_ext` crate.

```rust
use vo_ext::prelude::*;

#[vo_extern("fmt", "Println")]
fn println(args: AnySlot) -> i64 {
    // implementation
    0
}

#[vo_extern("math", "Add")]
fn add(a: i64, b: i64) -> i64 {
    a + b
}

// Required: export the extension table
vo_ext::export_extensions!();
```

## Discovery Mechanism

Unlike the previous symbol-based lookup, Vo extensions now expose a single entry point `vo_ext_get_entries` (generated by `export_extensions!`).

The VM loads the shared library and calls `vo_ext_get_entries` to get a table of function pointers and their metadata (names, signatures).

### Extension Table

```rust
#[repr(C)]
pub struct ExtensionTable {
    pub version: u32,
    pub entry_count: usize,
    pub entries: *const ExternEntry,
    // ...
}
```

## User Workflow

### 1. Vo side: Declare functions

```go
// math.vo
package math

func Add(a, b int) int
```

### 2. Rust side: Create native crate

```toml
[package]
name = "myext"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib"]

[dependencies]
vo-ext = { path = "../lang/crates/vo-ext" } # or version
```

```rust
use vo_ext::prelude::*;

#[vo_extern("math", "Add")]
fn add(a: i64, b: i64) -> i64 {
    a + b
}

vo_ext::export_extensions!();
```

### 3. Build and Run

```bash
cargo build --release
# The resulting .so/.dylib/.dll is loaded by Vo runtime
# (Configuration in vo.ext.toml matches Vo packages to library paths)
```

## Macro Expansion

The `#[vo_extern]` macro generates:
1. A wrapper function that handles argument unpacking from `ExternCall`.
2. An entry in a static array used by `export_extensions!`.

```rust
// Wrapper generation (simplified)
fn __vo_wrapper_add(call: &mut ExternCall) -> ExternResult {
    let a = call.arg_i64(0);
    let b = call.arg_i64(1);
    let ret = add(a, b);
    call.ret_i64(0, ret);
    ExternResult::Ok
}
```

## Type Mapping

| Rust Type | Vo Type |
|-----------|---------|
| `i64` | `int` |
| `f64` | `float64` |
| `bool` | `bool` |
| `&str` | `string` |
| `AnySlot` | `any` |
| `GcRef` | Reference types |


