// Test: Closure reference capture (Go semantics)
// Variables captured by closures should see mutations
package main

func main() {
    // Test 1: Basic reference capture - closure sees mutation
    x := 10
    f := func() int {
        return x
    }
    x = 20
    assert(f() == 20, "Test 1: closure should see mutated value")
    
    // Test 2: Multiple mutations
    y := 1
    g := func() int {
        return y
    }
    y = 2
    assert(g() == 2, "Test 2a: first mutation")
    y = 3
    assert(g() == 3, "Test 2b: second mutation")
    y = 100
    assert(g() == 100, "Test 2c: third mutation")
    
    // Test 3: Nested closure - inner sees outer's mutation
    outer := 100
    level1 := func() int {
        inner := func() int {
            return outer
        }
        return inner()
    }
    assert(level1() == 100, "Test 3a: before mutation")
    outer = 200
    assert(level1() == 200, "Test 3b: after mutation")
    
    // Test 4: Closure with parameter and captured var
    base := 10
    adder := func(n int) int {
        return base + n
    }
    assert(adder(5) == 15, "Test 4a: 10 + 5")
    base = 100
    assert(adder(5) == 105, "Test 4b: 100 + 5 after mutation")
    
    // Test 5: Multiple captured variables
    a := 1
    b := 2
    c := 3
    sum := func() int {
        return a + b + c
    }
    assert(sum() == 6, "Test 5a: 1+2+3")
    a = 10
    b = 20
    c = 30
    assert(sum() == 60, "Test 5b: 10+20+30 after mutations")
    
    // Test 6: Mutation before and after closure creation
    val := 1
    val = 2
    h := func() int {
        return val
    }
    val = 3
    assert(h() == 3, "Test 6: sees latest value")
    
    // Test 7: Deep nesting with mutations
    deep := 1000
    l1 := func() int {
        l2 := func() int {
            l3 := func() int {
                return deep
            }
            return l3()
        }
        return l2()
    }
    assert(l1() == 1000, "Test 7a: deep nesting initial")
    deep = 2000
    assert(l1() == 2000, "Test 7b: deep nesting after mutation")
    
    println("closure_capture: ALL TESTS PASSED")
}
